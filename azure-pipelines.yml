variables:
  coverageDirectory: coverage
  nodeVersion: 10.16.0
  reportsDirectory: reports
jobs:
  - job: root_linux
    displayName: Root on Linux
    pool:
      vmImage: ubuntu-16.04
    steps:
      - checkout: self
      - task: NodeTool@0
        displayName: Install Node
        inputs:
          versionSpec: $(nodeVersion)
      - script: npm install
        displayName: Install Node dependencies
      - script: mkdir --parents $(coverageDirectory) $(reportsDirectory)
        displayName: Setup
      - script: |
          npm run --silent lint-files
          npm run --silent lint-scripts -- --format junit --output-file $(reportsDirectory)/lint-scripts.xml
        displayName: Run static analysis
      - script: npm run --silent test-units -- --coverage --runInBand --reporters default jest-junit
        displayName: Run tests
        env:
          JEST_JUNIT_OUTPUT: $(reportsDirectory)/test-units.xml
      - script: npx codecov --token=$(codecovToken)
        displayName: Publish code coverage results
      - task: PublishPipelineArtifact@0
        displayName: Publish coverage artifact
        inputs:
          artifactName: coverage
          targetPath: $(coverageDirectory)
      - task: PublishPipelineArtifact@0
        displayName: Publish reports artifact
        inputs:
          artifactName: reports
          targetPath: $(reportsDirectory)
      - task: PublishTestResults@2
        displayName: Publish tests results
        condition: succeededOrFailed()
        inputs:
          testResultsFiles: '**/*.xml'
          searchFolder: $(System.DefaultWorkingDirectory)/$(reportsDirectory)
